
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../tutorials/population_discovery/">
      
      
        <link rel="next" href="../api/model/">
      
      
      <link rel="icon" href="../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.14">
    
    
      
        <title>Math background - Scyan</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.10ba22f1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#notations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Scyan" class="md-header__button md-logo" aria-label="Scyan" data-md-component="logo">
      
  <img src="../assets/logo_white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Scyan
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Math background
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/MICS-Lab/scyan" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    MICS-Lab/scyan
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Scyan" class="md-nav__button md-logo" aria-label="Scyan" data-md-component="logo">
      
  <img src="../assets/logo_white.svg" alt="logo">

    </a>
    Scyan
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/MICS-Lab/scyan" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    MICS-Lab/scyan
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../advice/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Usage advices
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/preprocessing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocessing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scyan usage and visualization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/batch_effect_correction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Batch effect correction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/debarcoding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debarcoding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/population_discovery/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Population discovery
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Math background
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Math background
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#notations" class="md-nav__link">
    <span class="md-ellipsis">
      Notations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generative-process" class="md-nav__link">
    <span class="md-ellipsis">
      Generative process
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#normalizing-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Normalizing flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loss" class="md-nav__link">
    <span class="md-ellipsis">
      Loss
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#annotating-cell-types" class="md-nav__link">
    <span class="md-ellipsis">
      Annotating cell-types
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#correcting-batch-effect" class="md-nav__link">
    <span class="md-ellipsis">
      Correcting batch effect
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    scyan.Scyan
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IO (read/write)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/preprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocessing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/plots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Plots
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/datasets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Loading/adding datasets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_7" >
        
          
          <label class="md-nav__link" for="__nav_6_7" id="__nav_6_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modules (advanced)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_7">
            <span class="md-nav__icon md-icon"></span>
            Modules (advanced)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/module/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    scyan.module.ScyanModule
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/prior/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    scyan.module.PriorDistribution
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/real_nvp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    scyan.module.RealNVP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/coupling_layer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    scyan.module.CouplingLayer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Advanced usage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Advanced usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Save your dataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/parameters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hyperparameters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/hydra_wandb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration and monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/scripts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLI/Running scripts
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cite us
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#notations" class="md-nav__link">
    <span class="md-ellipsis">
      Notations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generative-process" class="md-nav__link">
    <span class="md-ellipsis">
      Generative process
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#normalizing-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Normalizing flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loss" class="md-nav__link">
    <span class="md-ellipsis">
      Loss
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#annotating-cell-types" class="md-nav__link">
    <span class="md-ellipsis">
      Annotating cell-types
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#correcting-batch-effect" class="md-nav__link">
    <span class="md-ellipsis">
      Correcting batch effect
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Math background</h1>

<p>Here we briefly describe the maths behind Scyan. For more details, refer to the method section of <a href="https://doi.org/10.1093/bib/bbad260">our article</a>.</p>
<h2 id="notations">Notations</h2>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>Belongs to</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="arithmatex">\(P\)</span></td>
<td><span class="arithmatex">\(\mathbb{N}^*\)</span></td>
<td>Number of populations</td>
</tr>
<tr>
<td><span class="arithmatex">\(N\)</span></td>
<td><span class="arithmatex">\(\mathbb{N}^*\)</span></td>
<td>Number of cells</td>
</tr>
<tr>
<td><span class="arithmatex">\(M\)</span></td>
<td><span class="arithmatex">\(\mathbb{N}^*\)</span></td>
<td>Number of markers</td>
</tr>
<tr>
<td><span class="arithmatex">\(M_{c}\)</span></td>
<td><span class="arithmatex">\(\mathbb{N}^*\)</span></td>
<td>Number of covariates per cell</td>
</tr>
<tr>
<td><span class="arithmatex">\(\pmb{\pi} = (\pi_z)_{1 \leq z \leq P}\)</span></td>
<td><span class="arithmatex">\(]0, 1[^P\)</span></td>
<td>Population size ratios (i.e., <span class="arithmatex">\(\sum_z \pi_z = 1\)</span>). This parameter is learned during training.</td>
</tr>
<tr>
<td><span class="arithmatex">\(\pmb{\rho}\)</span></td>
<td><span class="arithmatex">\((\mathbb{R} \cup \{NA\})^{P \times M}\)</span></td>
<td>Knowledge table. For a population <span class="arithmatex">\(z\)</span> and a marker <span class="arithmatex">\(m\)</span>, the value <span class="arithmatex">\(\rho_{z,m}\)</span> describes the expected expression of <span class="arithmatex">\(m\)</span> by population <span class="arithmatex">\(z\)</span>. Typical values are: <span class="arithmatex">\(-1\)</span> for negative, <span class="arithmatex">\(1\)</span> for positive, NA when not known.</td>
</tr>
<tr>
<td><span class="arithmatex">\(\pmb{x_i}\)</span></td>
<td><span class="arithmatex">\(\mathbb{R}^M\)</span></td>
<td>Each <span class="arithmatex">\(\pmb{x_i}\)</span> is the vector of preprocessed marker expression of the cell <span class="arithmatex">\(i \in [1\cdots N]\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(\pmb{c_i}\)</span></td>
<td><span class="arithmatex">\(\mathbb{R}^{M_c}\)</span></td>
<td>Each <span class="arithmatex">\(\pmb{c_i}\)</span> is the vector of covariates associated to the cell <span class="arithmatex">\(i \in [1\cdots N]\)</span></td>
</tr>
</tbody>
</table>
<h2 id="generative-process">Generative process</h2>
<p>We assume that the cell expressions come from the generative process below, where <span class="arithmatex">\(f_{\pmb{\phi}}\)</span> is the normalizing flow detailed in the next section. We define the following random variables: <span class="arithmatex">\(Z\)</span> the random population, <span class="arithmatex">\(\pmb{E}\)</span> the population-specific latent marker expressions, <span class="arithmatex">\(\pmb{H}\)</span> a cell-specific term, <span class="arithmatex">\(\pmb{U}\)</span> the latent expressions, and <span class="arithmatex">\(\pmb{X}\)</span> the actual (preprocessed) marker expressions.</p>
<div class="arithmatex">\[
    Z \sim Categorical(\pmb{\pi})
\]</div>
<div class="arithmatex">\[\pmb{E} \; | \; Z = (e_m)_{1 \leq m \leq M} \mbox{, where }
        \left\{
            \begin{array}{ll}
                e_m = \rho_{Z,m} &amp; \mbox{if }\rho_{Z,m} \neq \mbox{NA} \\
                e_m \sim \mathcal{U}([-1, 1]) &amp; \mbox{otherwise,}
            \end{array}
        \right.
\]</div>
<div class="arithmatex">\[
    \pmb{H} \sim \mathcal{N}(\pmb{0}, \sigma \mathbb{\pmb{I_M}})
\]</div>
<div class="arithmatex">\[
    \pmb{U} = \pmb{E} + \pmb{H}
\]</div>
<div class="arithmatex">\[
    \pmb{X} = f_{\pmb{\phi}}^{-1}(\pmb{U})
\]</div>
<p>The latent distribution <span class="arithmatex">\(\pmb{U}\)</span> is defined on <span class="arithmatex">\(\mathbb{R}^M\)</span>, i.e. the same space as the original marker expressions. Each dimension of the latent space corresponds to one marker. These latent marker expressions are meant to be free of batch effect or any non-biological factor.</p>
<p>We can summarize this generative process with the figure below. <span class="arithmatex">\(\pmb{U}\)</span> corresponds to the mixture distribution in red (right), while <span class="arithmatex">\(\pmb{X}\)</span> corresponds to the distribution of cells marker expressions (left). The normalizing flow <span class="arithmatex">\(f_{\pmb{\phi}}\)</span> is the mapping between these two distributions.</p>
<p align="center">
  <img src="../assets/overview_b.png" alt="scyan_overview_b" />
</p>

<div class="admonition interpretation">
<p class="admonition-title">Interpretation</p>
<p>In this latent space, all marker expressions share the same scale (close to <span class="arithmatex">\([-1, 1]\)</span>, but not necessarily inside). For instance, a latent expression close to 1 is a positive expression, close to -1 is negative, while close to 0 would be a mid expression.</p>
</div>
<h2 id="normalizing-flow">Normalizing flow</h2>
<p>The normalizing flow is a stack of multiple coupling layers: <span class="arithmatex">\(f_{\pmb{\phi}} := f^{(L)} \circ f^{(L-1)} \circ \dots \circ f^{(1)}\)</span> with <span class="arithmatex">\(L\)</span> the number of coupling layers. Each coupling layer <span class="arithmatex">\(f^{(i)}: (\pmb{x}, \pmb{c}) \mapsto \pmb{y}\)</span> splits both <span class="arithmatex">\(\pmb{x}\)</span> and <span class="arithmatex">\(\pmb{y}\)</span> into two components <span class="arithmatex">\((\pmb{x^{(1)}}, \pmb{x^{(2)}}), (\pmb{y^{(1)}}, \pmb{y^{(2)}})\)</span> on which distinct transformations are applied (the split is different for each layer). We propose below an extension of the traditional coupling layer to integrate covariates <span class="arithmatex">\(\pmb{c}\)</span>:</p>
<div class="arithmatex">\[
    \begin{cases}
      \pmb{y^{(1)}} = \pmb{x^{(1)}}\\
      \pmb{y^{(2)}} = \pmb{x^{(2)}} \odot exp\Big(s([\pmb{x^{(1)}}; \pmb{c}])\Big) + t([\pmb{x^{(1)}}; \pmb{c}]).
    \end{cases}  
\]</div>
<p>On the equation above, <span class="arithmatex">\(s\)</span> and <span class="arithmatex">\(t\)</span> are Multi-Layer-Perceptrons (MLPs). The coupling layer architecture is illustrated below:</p>
<p align="center">
  <img src="../assets/overview_c.png" alt="scyan_overview_c" width="25%"/>
</p>

<p>Overall, the normalizing flow has some interesting properties that help preserve the biological variability as much as possible:</p>
<ul>
<li>The coupling layers preserve the order relation for two different expression values.</li>
<li>The loss penalizes huge space distortion (the log determinant term in the equation below).</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each coupling layer is invertible, so is <span class="arithmatex">\(f_{\pmb{\phi}}\)</span>. Also, the log determinant of the jacobian of each layer is easy to compute, which is crucial to compute the loss function below.</p>
</div>
<h2 id="loss">Loss</h2>
<p>We optimize the Kullback–Leibler (KL) divergence defined below by stochastic gradient descent. More details leading to this expression and how to compute it can be found in the article methods section.</p>
<div class="arithmatex">\[
    \mathcal{L}_{KL}(\pmb{\theta}) = - \sum_{1 \leq i \leq N} \bigg[ log \: \Big( p_U(f_{\pmb{\phi}}(\pmb{x_i}, \pmb{c_i}); \pmb{\pi}) \Big) + log \;  \Big| det \frac{\partial f_{\pmb{\phi}}(\pmb{x_i}, \pmb{c_i})}{\partial \pmb{x}^T} \Big| \bigg].
\]</div>
<p>We optimize the loss on mini-batches of cells using the Adam optimizer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the above equation, <span class="arithmatex">\(p_U(f_{\pmb{\phi}}(\pmb{x_i}, \pmb{c_i}); \pmb{\pi}) = \sum_{z=1}^P \pi_z \cdot p_{U \mid Z = z}(f_{\pmb{\phi}}(\pmb{x_i}, \pmb{c_i}))\)</span>, which is not computationally tractable because the presence of NA in <span class="arithmatex">\(\pmb{\rho}\)</span> leads to the summation of a uniform and a normal random variable. We approximate the density of the sum of the two random variables by a piecewise density function.</p>
</div>
<h2 id="annotating-cell-types">Annotating cell-types</h2>
<p>Once finished training, the annotation process <span class="arithmatex">\(\mathcal{A}_{\pmb{\theta}}\)</span> consists in choosing the most likely population according to the data using Bayes's rule. So, for a cell <span class="arithmatex">\(\pmb{x}\)</span> with covariates <span class="arithmatex">\(\pmb{c}\)</span>, we have:</p>
<div class="arithmatex">\[
    \mathcal{A}_{\pmb{\theta}}(\pmb{x}, \pmb{c}) = argmax_{1 \leq z \leq P} \; \; \pi_z \cdot p_{U \mid Z = z}(f_{\pmb{\phi}}(\pmb{x}, \pmb{c})).
\]</div>
<p>We also define a log threshold <span class="arithmatex">\(t_{min}\)</span> to decide whether or not to label a cell, i.e., we don't label a cell if <span class="arithmatex">\(max_{1 \leq z \leq P} \; \; p_{U \mid Z = z}(f_{\pmb{\phi}}(\pmb{x}, \pmb{c})) \leq e^{t_{min}}\)</span>.</p>
<h2 id="correcting-batch-effect">Correcting batch effect</h2>
<p>When the batches are provided into the covariates, the normalizing flow will naturally learn to align the latent representations of the multiple different batches. After model training, we can choose a batch as the reference and its corresponding covariates <span class="arithmatex">\(\pmb{c}_{ref}\)</span>. Then, for a cell <span class="arithmatex">\(\pmb{x}\)</span> with covariates <span class="arithmatex">\(\pmb{c} \neq \pmb{c_{ref}}\)</span>, its batch-effect corrected expressions are, <span class="arithmatex">\(\tilde{\pmb{x}} = f_{\pmb{\phi}}^{-1}\Big(f_{\pmb{\phi}}(\pmb{x}, \pmb{c}), \pmb{c_{ref}}\Big)\)</span>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this manner, we get expressions <span class="arithmatex">\(\tilde{\pmb{x}}\)</span> as if <span class="arithmatex">\(\pmb{x}\)</span> were cell expressions from the reference batch. Applying <span class="arithmatex">\(f_{\pmb{\phi}}\)</span> removes the batch effect, and applying <span class="arithmatex">\(f_{\pmb{\phi}}^{-1}\)</span> recreates expressions that look like expressions of the reference batch.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 - 2022 Quentin Blampey
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.bd41221c.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>